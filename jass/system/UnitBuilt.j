function initNeutralStructures takes nothing returns nothing
    call SaveInteger(NHT, 'o00S', 0, 'I02F')
    call SaveInteger(NHT, 'o00Z', 0, 'I02G')
    call SaveInteger(NHT, 'o010', 0, 'I02H')
    call SaveInteger(NHT, 'O00Y', 0, 'I02I')
    call SaveInteger(NHT, 'n02S', 0, 'I05B')
    call SaveInteger(NHT, 'o00B', 0, 'I02O')
    call SaveInteger(NHT, 'n015', 0, 'I030')
    call SaveInteger(NHT, 'n017', 0, 'I02U')
    call SaveInteger(NHT, 'O003', 0, 'I036')
    call SaveInteger(NHT, 'n01E', 0, 'I03L')
    call SaveInteger(NHT, 'n01Z', 0, 'I04D')
    call SaveInteger(NHT, 'n01Y', 0, 'I04C')
    call SaveInteger(NHT, 'n00Z', 0, 'I02Z')
    call SaveInteger(NHT, 'n008', 0, 'I03G')
    call SaveInteger(NHT, 'n01N', 0, 'I03U')
    call SaveInteger(NHT, 'n01S', 0, 'I046')
    call SaveInteger(NHT, 'h00G', 0, 'I03A')
    call SaveInteger(NHT, 'n029', 0, 'I04P')
    call SaveInteger(NHT, 'n02J', 0, 'I051')
    call SaveInteger(NHT, 'e00A', 0, 'I03Y')
    call SaveInteger(NHT, 'n01J', 0, 'I03R')
    call SaveInteger(NHT, 'n003', 0, 'I043')
    call SaveInteger(NHT, 'n01F', 0, 'I03M')
    call SaveInteger(NHT, 'n01K', 0, 'I03P')
    call SaveInteger(NHT, 'e00D', 0, 'I041')
    call SaveInteger(NHT, 'n00A', 0, 'I04N')
    call SaveInteger(NHT, 'h00V', 0, 'I05K')
    call SaveInteger(NHT, 'h00R', 0, 'I05G')
    call SaveInteger(NHT, 'n01I', 0, 'I03Q')
    call SaveInteger(NHT, 'e00C', 0, 'I042')
    call SaveInteger(NHT, 'e00B', 0, 'I03Z')
    call SaveInteger(NHT, 'o00V', 0, 'I05Y')
    call SaveInteger(NHT, 'h00Z', 0, 'I05O')
    call SaveInteger(NHT, 'O00X', 0, 'I060')
    call SaveInteger(NHT, 'h012', 0, 'I05R')
    call SaveInteger(NHT, 'n01D', 0, 'I03K')
    call SaveInteger(NHT, 'h00T', 0, 'I05I')
    call SaveInteger(NHT, 'n026', 0, 'I04K')
    call SaveInteger(NHT, 'n02C', 0, 'I04S')
    call SaveInteger(NHT, 'n02M', 0, 'I054')
    call SaveInteger(NHT, 'n014', 0, 'I02Y')
    call SaveInteger(NHT, 'H000', 0, 'I04M')
    call SaveInteger(NHT, 'n018', 0, 'I03E')
    call SaveInteger(NHT, 'n01L', 0, 'I03S')
    call SaveInteger(NHT, 'n01Q', 0, 'I044')
    call SaveInteger(NHT, 'n012', 0, 'I02W')
    call SaveInteger(NHT, 'h00B', 0, 'I038')
    call SaveInteger(NHT, 'h010', 0, 'I05P')
    call SaveInteger(NHT, 'h013', 0, 'I05S')
    call SaveInteger(NHT, 'h014', 0, 'I05T')
    call SaveInteger(NHT, 'e000', 0, 'I03X')
    call SaveInteger(NHT, 'n01V', 0, 'I049')
    call SaveInteger(NHT, 'o00U', 0, 'I05W')
    call SaveInteger(NHT, 'n01M', 0, 'I03T')
    call SaveInteger(NHT, 'n01R', 0, 'I045')
    call SaveInteger(NHT, 'n001', 0, 'I02V')
    call SaveInteger(NHT, 'h001', 0, 'I037')
    call SaveInteger(NHT, 'n02A', 0, 'I04Q')
    call SaveInteger(NHT, 'n02K', 0, 'I052')
    call SaveInteger(NHT, 'n020', 0, 'I04E')
    call SaveInteger(NHT, 'n02F', 0, 'I04W')
    call SaveInteger(NHT, 'n02P', 0, 'I058')
    call SaveInteger(NHT, 'n02E', 0, 'I04U')
    call SaveInteger(NHT, 'n02N', 0, 'I056')
    call SaveInteger(NHT, 'o00W', 0, 'I05Z')
    call SaveInteger(NHT, 'o001', 0, 'I02P')
    call SaveInteger(NHT, 'n010', 0, 'I031')
    call SaveInteger(NHT, 'n01A', 0, 'I03H')
    call SaveInteger(NHT, 'o00C', 0, 'I02Q')
    call SaveInteger(NHT, 'n013', 0, 'I032')
    call SaveInteger(NHT, 'h00O', 0, 'I05D')
    call SaveInteger(NHT, 'n00B', 0, 'I04Y')
    call SaveInteger(NHT, 'h00P', 0, 'I05E')
    call SaveInteger(NHT, 'H017', 0, 'I05V')
    call SaveInteger(NHT, 'h00W', 0, 'I05L')
    call SaveInteger(NHT, 'n01H', 0, 'I03O')
    call SaveInteger(NHT, 'e001', 0, 'I040')
    call SaveInteger(NHT, 'n023', 0, 'I04H')
    call SaveInteger(NHT, 'n028', 0, 'I04O')
    call SaveInteger(NHT, 'n02I', 0, 'I050')
    call SaveInteger(NHT, 'h00Y', 0, 'I05N')
    call SaveInteger(NHT, 'h00C', 0, 'I03B')
    call SaveInteger(NHT, 'n01W', 0, 'I04A')
    call SaveInteger(NHT, 'h011', 0, 'I05Q')
    call SaveInteger(NHT, 'n01X', 0, 'I04B')
    call SaveInteger(NHT, 'n01G', 0, 'I03N')
    call SaveInteger(NHT, 'N00G', 0, 'I05C')
    call SaveInteger(NHT, 'o000', 0, 'I02N')
    call SaveInteger(NHT, 'o00D', 0, 'I02R')
    call SaveInteger(NHT, 'n002', 0, 'I033')
    call SaveInteger(NHT, 'n02R', 0, 'I05A')
    call SaveInteger(NHT, 'n022', 0, 'I04G')
    call SaveInteger(NHT, 'n01O', 0, 'I03V')
    call SaveInteger(NHT, 'n01T', 0, 'I047')
    call SaveInteger(NHT, 'h00U', 0, 'I05J')
    call SaveInteger(NHT, 'h015', 0, 'I05U')
    call SaveInteger(NHT, 'n025', 0, 'I04J')
    call SaveInteger(NHT, 'h00X', 0, 'I05M')
    call SaveInteger(NHT, 'n024', 0, 'I04I')
    call SaveInteger(NHT, 'h00Q', 0, 'I05F')
    call SaveInteger(NHT, 'n007', 0, 'I03D')
    call SaveInteger(NHT, 'n000', 0, 'I02S')
    call SaveInteger(NHT, 'n016', 0, 'I034')
    call SaveInteger(NHT, 'H004', 0, 'I03W')
    call SaveInteger(NHT, 'n01U', 0, 'I048')
    call SaveInteger(NHT, 'n019', 0, 'I03F')
    call SaveInteger(NHT, 'h00S', 0, 'I05H')
    call SaveInteger(NHT, 'n01C', 0, 'I03J')
    call SaveInteger(NHT, 'n02B', 0, 'I04R')
    call SaveInteger(NHT, 'n02L', 0, 'I053')
    call SaveInteger(NHT, 'n00Y', 0, 'I02X')
    call SaveInteger(NHT, 'h00F', 0, 'I039')
    call SaveInteger(NHT, 'n021', 0, 'I04F')
    call SaveInteger(NHT, 'h00H', 0, 'I03C')
    call SaveInteger(NHT, 'n00C', 0, 'I04V')
    call SaveInteger(NHT, 'n02O', 0, 'I057')
    call SaveInteger(NHT, 'n01B', 0, 'I03I')
    call SaveInteger(NHT, 'n027', 0, 'I04L')
    call SaveInteger(NHT, 'o00T', 0, 'I05X')
    call SaveInteger(NHT, 'n02H', 0, 'I04Z')
    call SaveInteger(NHT, 'n02D', 0, 'I04T')
    call SaveInteger(NHT, 'n00E', 0, 'I055')
    call SaveInteger(NHT, 'n011', 0, 'I02T')
    call SaveInteger(NHT, 'o002', 0, 'I035')
    call SaveInteger(NHT, 'n02G', 0, 'I04X')
    call SaveInteger(NHT, 'n02Q', 0, 'I059')
endfunction
function getStructItem takes integer unitId returns integer
    return LoadInteger(NHT, unitId, 0)
endfunction
function UnitBuilt_Conditions takes nothing returns boolean
    local unit u = GetTriggerUnit()
    local player p = GetOwningPlayer(u)
    if GetPlayerState(p, PLAYER_STATE_RESOURCE_FOOD_USED) > GetPlayerState(p, PLAYER_STATE_RESOURCE_FOOD_CAP) then
        call RemoveUnit(u)
        call DisplayTextToPlayer(p, 0, 0, "|CFFFF0000人口达到上限，无法继续建造，物品归还至门派建造者")
        call UnitAddItemById(builder[1 + GetPlayerId(p)], getStructItem(GetUnitTypeId(u)))
    endif
    set p = null
    set u = null
    return false
endfunction

function UnitBuiltFinish_Conditions takes nothing returns boolean
    local unit u = GetTriggerUnit()
    local integer level = 0
    if not IsUnitType(u, UNIT_TYPE_HERO) then
        set level = LoadInteger(YDHT, getStructItem(GetUnitTypeId(u)), TOWER_LEVEL_KEY)
        if level == 1 then
            call SaveEffectHandle(YDHT, GetHandleId(u), $A0B0C0, AddSpecialEffect("war3mapImported\\pinzhi-lan.mdx", GetUnitX(u), GetUnitY(u)))
        elseif level == 2 then
            call SaveEffectHandle(YDHT, GetHandleId(u), $A0B0C0, AddSpecialEffect("war3mapImported\\pinzhi-zi.mdx", GetUnitX(u), GetUnitY(u)))
        elseif level == 3 then
            call SaveEffectHandle(YDHT, GetHandleId(u), $A0B0C0, AddSpecialEffect("war3mapImported\\pinzhi-cheng.mdx", GetUnitX(u), GetUnitY(u)))
        elseif level == 4 then
            call SaveEffectHandle(YDHT, GetHandleId(u), $A0B0C0, AddSpecialEffect("war3mapImported\\pinzhi-hong.mdx", GetUnitX(u), GetUnitY(u)))
        endif
    endif
    set u = null
    return false
endfunction

function UnitBuilt takes nothing returns nothing
    local trigger t = CreateTrigger()
    call initNeutralStructures()
    call TriggerRegisterAnyUnitEventBJ(t, EVENT_PLAYER_UNIT_CONSTRUCT_START)
    call TriggerAddCondition(t, Condition(function UnitBuilt_Conditions))

    set t = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(t, EVENT_PLAYER_UNIT_CONSTRUCT_FINISH)
    call TriggerAddCondition(t, Condition(function UnitBuiltFinish_Conditions))
    set t = null
endfunction
